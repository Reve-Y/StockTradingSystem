## 需求分析与设计说明文档

### 1. 业务描述    
#### 1.1 业务问题分析   
  本系统最终应实现一个近似真实交易环境的仿真模拟股票交易系统。市场上真实的交易环境普遍采用，为方便用户使用，我们采用B/S架构进行开发，这样用户登录网页就可以进行模拟交易操作。实际上真实的股票交易涉及到的功能和业务知识很多，在这里我们的设计目标仅仅是最重要的几个功能：包括证券信息的查询（真实数据）、根据开户时我们分配的资金进行模拟买卖以及后台管理等功能。后续可继续开发完善系统。

#### 2.2 系统人员分析        
本系统的使用者有以下几种角色：   
* 普通用户   
  指一般客户。用户首次访问页面时，可以进行注册，注册后，自动登录。这只是普通信息的注册，此时还并未开通证券账户和资金账户，打开后台管理页面可以进行证券账户和资金账户的设置。因为是虚拟的账户，请求开通时，为简化用户的操作，我们会为用户提供一个"一键生成所有信息"的功能，包括资金账号、开户行、银行卡号等等信息，用户只需点击下一步即可一步步完成开户操作。开户后，可以在后台管理页面看到自己的账户信息。然后在转到股票信息页面就可以进行模拟交易了。市场上真实的开户过程中会验证很多身份信息，在这里我们不做校验。

* 管理员    
  对当前已经注册的用户信息进行管理。查看操作记录等。

### 2. 主要业务流程   
本系统的业务流程主要有交易、查询和账户管理三个部分。其中交易部分的主要流程有证券买入、卖出和委托撤单；   
查询部分的主要流程有股票信息查询、操作记录查询；账户管理分为普通账户管理和管理员的用户管理。

#### 2.1 证券买入流程    
  委托买入操作： 用户登录系统并已开户后，进入股票信息查询的页面实现买入股票功能。用户可自行输入股票代码查询某支股票的具体信息，然后填写相应的委托数据进行交易。 这里的主要工作是检查股票代码的正确性，显示对应股票的详细信息，包括该支股票近日行情的折线图、买一到买五和卖一到卖五的单价与数量和一些其他的基本信息。 随后用户可自行调整购买数量和价格。 购买时应满足交易所的相关规定， 比如委托价格应限制在当日开盘价上下浮动的百分之十价格范围内， 操作时的委托数量必须以 100 股为一个交易单位， 即用户买入股票是必须大于等于 100 股且是 100 股的整数倍。   
  为增加用户体验，本系统对交易规则进行改进，用户进行委托后，当天会根据真实的行情进行模拟撮合，具体参考下列交易规则，符合成交规则的交易，系统会认为这笔买入操作已经成交，这时用户个人账户信息里的历史委托信息和账户的可用资金、 总资产信息，都会通过发送请求进行相应的数据库更新。

#### 2.2 证券卖出流程   
  委托卖出操作：当用户进行证券卖出时，系统应显示用户持有股票，即持仓信息。 用户选择要卖出的股票，卖出时同样需要符合交易规则。 比如委托价格应限制在当日开盘价上下浮动的百分之十价格范围内，操作时的委托数量必须以 100 股为一个交易单位， 即用户卖出股票时必须大于等于 100 股且是 100 股的整数倍， 不满 100 股的零头必须一次性卖出。 当操作成功时， 系统立即按照我们指定的交易规则进行交易。 操作成功后，用户个人账户信息里的历史委托信息和账户的可用资金、 总资产信息，以及系统的未成交委托单库都会通过计算发生相应的更新。

### * 交易规则   
1. 模拟炒股接受24小时委托（清算时间除外），非交易时间和清算时间，用户的委托将参加下一次开市后的撮合。   

2. 清算时间：每日15：20-15：45，清算时间内不允许下单委托   

3. 交易时间和交易所规定的交易时间是同步的，在国家法定节假日只接受委托，但不会撮合成交   

4. 支持上交所和深交所两大交易所上市的A股股票，不支持新股   

5. 交易手续费为万分之5    

6. 成交规则：撮合系统每10秒进行一次交易撮合，处理买单、卖单、撤单。   
   成交价格：   
   按照交易所公布的最新成交价撮合，而不是按照买卖盘的价格撮合。   
   买入时：如果最新成交价等于委托价，按照委托价成交，如果最新价小于委托价，按照最新价撮合成交，涨停不能买入。   
   卖出时：如果最新成交价等于委托价，按照委托价成交，如果最新价高于委托价，按照最新价撮合成交，跌停不能卖出。   
   成交数量：   
   模拟炒股的撮合考虑了真实交易的成交数量，即使委托价格合适，如果没有成交量，也不会成交。如果真实交易的成交数量小于委托数量，则部分成交，仅撮合真实交易的成交数量，剩余的委托仍保留在撮合队列，等待新的成交明细。（真实交易的成交数量可以从真实行情中看到）。   
   对于没有成交的委托，或者部分成交的委托，可以撤单。当天的委托如果没有成交，收市以后自动作废，不参加下一交易日的撮合。   
   
7. 涨跌停限制：
  1、股票涨停时，以涨停价提交的委托，放入撮合等待队列，并且记录当时买一量，如果阶段成交量大于买一量，可成交数量是阶段成交量和当时的买一量的差，以这种方式模拟在真实交易市场排队的情形。模拟炒股无法考虑真实市场中，买一上的撤单。如果涨停板被打开，价格低于委托价，则按照现价成交。   
  例如：600804(鹏 博 士)上午开市后涨停，用户在10:10以涨停价委托买入100手，此时的成交量是51000手，涨停板上买一的单子是5000手，如果涨停板没有被打开，只有阶段成交量大于5000手时，用户的委托才等到可以成交。如果成交量到了56010手，则用户成交10手（56010-51000-5000），剩下的部分等待更多的成交量。   
  2、股票跌停时，以跌停价提交的委托，放入撮合等待队列，并且记录当时卖一量，如果阶段成交量大于卖一量，可成交数量是阶段成交量和当时的卖一量的差，以这种方式模拟在真实交易市场排队的情形。模拟炒股无法考虑真实市场中，卖一上的撤单。如果跌停板被打开，价格高于委托价，则按照现成交。（阶段成交量：提交委托时刻起该股票的真实成交量。） 

#### 2.3 后台管理：委托撤单   
  委托撤单是用户在交易活动中常用的功能之一， 主要针对以下状态的单子进行操作。   
  当用户进行委托后（买入或卖出），暂时没有交易成功的订单，单子的状态为委托中。这种订单可以选择撤单，撤单后对应的委托单将从可撤单库中清除，同时返还冻结的资金或股票， 更新客户账户里对应的资金账户信息或者持有股票信息。  
  已经废弃或者成交的订单只做显示，不可进行操作。

#### 2.4 后台管理：持仓查询     
  用户打开后台管理页面，点击相应标签，可以看到目前账户的持仓情况。具体包括以下信息：   
  1. 持仓表：证券账户号、证券名称、证券代码、持有数量     
    

#### 2.5 后台管理：资金查询     
  用户打开后台管理页面，点击相应标签，可以看到目前账户的资金情况。具体包括以下信息   
  1. 资金表：资金账户序号、开户行、银行卡号、冻结金额、可用余额、账户余额

#### 2.6 后台管理：订单查寻     
  用户打开后台管理页面，点击相应标签，可以看到目前账户的订单情况。具体包括历史所有已成交的、未成交的、废弃的订单和已撤销的订单。

#### 2.7 后台管理：信息修改
  可以修改用户的基本信息，更新数据库。但是无法修改注册时的手机号和证券账户等。
